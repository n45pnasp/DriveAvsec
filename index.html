<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Alat Cek Produk</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://unpkg.com/html5-qrcode@2.3.10"></script>
</head>
<body>
  <header>
    <div class="container">
      <h1>Alat Cek Produk</h1>
    </div>
  </header>

  <main class="container">
    <div class="card">
      <div id="statusMessage" class="status-message"></div>

      <div class="form-group">
        <label for="barcode">Barcode:</label>
        <div class="input-with-button">
          <input type="text" id="barcode" placeholder="Scan atau masukkan barcode">
          <button class="btn btn-secondary" onclick="startScanner()">Scan</button>
        </div>
        <div id="qr-reader" style="display:none; width:100%; max-width:400px; margin-top:10px; border:1px solid #ccc; border-radius:8px;"></div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="productName">Nama Produk:</label>
          <input type="text" id="productName" placeholder="Nama produk">
        </div>

        <div class="form-group quantity-group">
          <label for="quantity">Jumlah:</label>
          <input type="number" id="quantity" value="1" min="1">
        </div>
      </div>

      <div class="form-group">
        <label for="price">Harga (Rp):</label>
        <input type="number" id="price" placeholder="Harga produk">
      </div>

      <button id="saveBtn" class="btn btn-primary" onclick="saveProduct()">
        Simpan Produk
        <span id="saveSpinner" class="loading"></span>
      </button>
    </div>

    <div class="card">
      <div class="form-group">
        <label for="search">Cari Produk:</label>
        <input type="text" id="search" placeholder="Cari berdasarkan barcode atau nama" oninput="searchProducts()">
      </div>

      <div class="table-container">
        <table id="productTable">
          <thead>
            <tr>
              <th>Barcode</th>
              <th>Nama Produk</th>
              <th>Jumlah</th>
              <th>Harga</th>
              <th>Aksi</th>
            </tr>
          </thead>
          <tbody id="productList">
            <!-- Data produk akan dimuat di sini -->
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzer87iN1PfL8GMx_jlm0Ix-u3PSbc_7sk3G2m0BKAiprNKG1lMjHKtzo1YB0H-qQKO/exec';
    let products = [];
    let html5QrCode;

    function showStatus(msg, isSuccess) {
      const status = document.getElementById('statusMessage');
      status.textContent = msg;
      status.className = isSuccess ? 'status-message success' : 'status-message error';
      status.style.display = 'block';
      setTimeout(() => status.style.display = 'none', 3000);
    }

    function formatCurrency(amount) {
      return new Intl.NumberFormat('id-ID', {
        style: 'currency', currency: 'IDR', minimumFractionDigits: 0
      }).format(amount);
    }

    async function loadProducts() {
      try {
        const response = await fetch(`${SCRIPT_URL}?t=${Date.now()}`);
        if (!response.ok) throw new Error('Gagal memuat data');
        const data = await response.json();
        if (Array.isArray(data)) {
          products = data;
          displayProducts(products);
        } else {
          throw new Error('Format data tidak valid');
        }
      } catch (err) {
        showStatus('Gagal memuat data produk: ' + err.message, false);
      }
    }

    function displayProducts(list) {
      const tbody = document.getElementById('productList');
      tbody.innerHTML = '';
      if (list.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5" class="no-data">Tidak ada data produk</td></tr>`;
        return;
      }
      list.forEach(p => {
        tbody.innerHTML += `
          <tr>
            <td>${p.Barcode || p.barcode}</td>
            <td>${p['Nama Produk'] || p.productName}</td>
            <td>${p.Jumlah || p.quantity}</td>
            <td>${formatCurrency(p.Harga || p.price)}</td>
            <td>
              <button class="btn btn-small btn-secondary" onclick="editProduct('${p.Barcode || p.barcode}')">Edit</button>
              <button class="btn btn-small btn-danger" onclick="deleteProduct('${p.Barcode || p.barcode}')">Hapus</button>
            </td>
          </tr>
        `;
      });
    }

    function searchProducts() {
      const term = document.getElementById('search').value.toLowerCase();
      const filtered = products.filter(p =>
        (p.Barcode || p.barcode || '').toLowerCase().includes(term) ||
        (p['Nama Produk'] || p.productName || '').toLowerCase().includes(term)
      );
      displayProducts(filtered);
    }

    async function saveProduct() {
      const barcode = document.getElementById('barcode').value.trim();
      const name = document.getElementById('productName').value.trim();
      const qty = document.getElementById('quantity').value.trim() || '1';
      const price = document.getElementById('price').value.trim();

      if (!barcode || !name || !price) {
        showStatus('Barcode, Nama Produk, dan Harga harus diisi!', false);
        return;
      }

      const saveBtn = document.getElementById('saveBtn');
      const spinner = document.getElementById('saveSpinner');
      saveBtn.disabled = true; spinner.style.display = 'inline-block';

      try {
        const formData = new FormData();
        formData.append('barcode', barcode);
        formData.append('productName', name);
        formData.append('quantity', qty);
        formData.append('price', price);
        const res = await fetch(SCRIPT_URL, { method: 'POST', body: formData });
        const result = await res.json();
        if (result.success) {
          showStatus('Produk berhasil disimpan!', true);
          resetForm(); await loadProducts();
        } else {
          throw new Error(result?.error || 'Gagal menyimpan produk');
        }
      } catch (err) {
        showStatus('Gagal menyimpan produk: ' + err.message, false);
      } finally {
        saveBtn.disabled = false; spinner.style.display = 'none';
      }
    }

    function resetForm() {
      document.getElementById('barcode').value = '';
      document.getElementById('productName').value = '';
      document.getElementById('quantity').value = '1';
      document.getElementById('price').value = '';
      document.getElementById('barcode').focus();
    }

    function editProduct(barcode) {
      const p = products.find(p => (p.Barcode || p.barcode) === barcode);
      if (p) {
        document.getElementById('barcode').value = p.Barcode || p.barcode;
        document.getElementById('productName').value = p['Nama Produk'] || p.productName;
        document.getElementById('quantity').value = p.Jumlah || p.quantity || '1';
        document.getElementById('price').value = p.Harga || p.price;
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
    }

    async function deleteProduct(barcode) {
      if (!confirm('Hapus produk ini?')) return;
      try {
        const formData = new FormData();
        formData.append('delete', barcode);
        const res = await fetch(SCRIPT_URL, { method: 'POST', body: formData });
        const result = await res.json();
        if (result.success) {
          showStatus('Produk berhasil dihapus!', true);
          await loadProducts();
        } else {
          throw new Error(result?.error || 'Gagal menghapus produk');
        }
      } catch (err) {
        showStatus('Gagal menghapus produk: ' + err.message, false);
      }
    }

    async function startScanner() {
      const reader = document.getElementById("qr-reader");
      reader.style.display = "block";

      if (!html5QrCode) {
        html5QrCode = new Html5Qrcode("qr-reader");
      }

      try {
        const cameras = await Html5Qrcode.getCameras();
        if (!cameras || cameras.length === 0) throw "Kamera tidak tersedia.";
        const cameraId = cameras[0].id;

        html5QrCode.start(
          cameraId,
          {
            fps: 10,
            qrbox: { width: 250, height: 100 },
            formatsToSupport: [
              Html5QrcodeSupportedFormats.CODE_128,
              Html5QrcodeSupportedFormats.CODE_39,
              Html5QrcodeSupportedFormats.EAN_13,
              Html5QrcodeSupportedFormats.UPC_A
            ]
          },
          decoded => {
            document.getElementById("barcode").value = decoded;
            html5QrCode.stop().then(() => {
              reader.style.display = "none";
            });
          },
          error => {
            console.warn("Scanning error:", error);
          }
        );
      } catch (err) {
        alert("Tidak dapat membuka kamera: " + err + ". Gunakan input manual.");
        reader.style.display = "none";
      }
    }

    document.addEventListener('DOMContentLoaded', loadProducts);
  </script>
</body>
</html>
